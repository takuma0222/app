# チャンバ状態チェック要件（v4）

## 1. 前提整理

### 1.1 システム構成

- **MES**: 予約管理・ロット管理を担う上位システム
- **App**: 機種ごとに存在し、装置ごとに個別カスタマイズされている制御アプリケーション
- **装置**: 実際の処理を行う製造装置

### 1.2 システム間の情報分布

| 情報 | App | MES（予約） | 着工指示（App→装置） |
|------|-----|-------------|---------------------|
| 装置ID | ○ | ○ | ○ |
| カードNo | ○ | ○ | ○ |
| 今回レシピID | × | **○** | **○** |
| 今回使用ポート（搬送レシピ） | × | × | **○**（App が決定） |
| 前回レシピID | **○** | × | − |
| 前回使用ポート | **○** | × | − |
| 前回完了時刻 | **○** | **○** | − |
| 装置の現在処理中ポート | **○** | × | − |
| レシピの想定処理時間 | × | × | × |

**重要な前提**:
- 着工指示は **MES ではなく App が装置に対して発行**
- App→MES への予約は **装置 + カードNo** のみ（既存仕様）
- MES は **今回レシピID** を保持しているが、予約IFには含まれない
- MES の予約には搬送レシピ（使用ポート情報）が無い
- **レシピの想定処理時間はどのシステムも保持していない**
- 完了時刻は App・MES 双方が保持

### 1.3 要件一覧

| # | 要件 | 概要 | 判定実施場所 |
|---|------|------|-------------|
| R1 | 時間制約付き特定レシピ判定 | 特定レシピ群の前回完了から一定時間以内に次の着工を行わなければ NG | **App（装置個別）** |
| R2 | 介在レシピ許容 | 対象レシピ間に別レシピが挟まっても OK | App（装置個別） |
| R3 | ポート競合待ち/ダミーロット | 処理中ポートと今回使用ポートが異なる場合、ダミーロットで前処理が必要な装置がある | **App（装置個別）** |
| R4 | MES予約時の参考チェック | 予約時に時間制約の残り時間を参考表示し、オペレータに警告 | **MES（共通）** |

---

## 2. 設計方針

### 2.1 判定の責任分界

| 判定内容 | 実施場所 | 理由 |
|---------|---------|------|
| 時間制約チェック（R1） | **App** | 装置ごとに個別カスタマイズが必要。レシピグループ・閾値は装置固有 |
| ポート競合/ダミーロット（R3） | **App** | 装置の構造・ポート構成に強く依存。完全に装置個別仕様 |
| 予約時参考警告（R4） | **MES** | 全装置共通のロジックで実現可能。MES予約で完結できる |

**方針**: 
- 装置個別カスタマイズが必要な判定（R1, R3）は **App 側で実装**
- MES で完結できる共通ロジック（R4）は **MES 側で実装**
- MES IF の変更は最小限に

### 2.2 タイマー起点 = 完了時刻

- App・MES 双方が完了時刻を保持しているため、タイマー起点は **前回完了時刻** とする
- 着工時刻ではなく完了時刻を使うことで、処理時間のばらつきに左右されない安定した判定が可能

### 2.3 判定粒度 ― 装置単位 vs ポート単位

| モード | 判定キー | ユースケース |
|--------|---------|-------------|
| 装置単位 | `equipment_id` + `recipe_group_id` | 装置全体で共有するプロセス条件の維持 |
| ポート単位 | `equipment_id` + `port_id` + `recipe_group_id` | チャンバ/ポートごとにコンディションが異なる場合 |

設定マスタの `scope` カラムで切り替える（App 側マスタ）

---

## 3. 業務ルール

### 3.1 判定タイミング

| フェーズ | 実施場所 | 実施内容 | 判定結果 |
|---------|---------|---------|---------|
| 予約登録（UI→MES） | **MES** | 装置 + カードNo を受付 | 予約登録 |
| ↳ 参考チェック（R4） | **MES** | App から前回完了時刻を取得し、経過時間を計算。閾値に近い場合は **参考警告** を表示 | 警告のみ（予約は通す） |
| 予約確定（App←MES） | MES | 装置 + カードNo を App に通知 | − |
| 着工判定 | **App** | MES からの予約情報と装置状態から、着工可否を判定（R1, R3） | ALLOW / REJECT / WAIT |
| 着工指示（App→装置） | App | 判定が ALLOW の場合のみ装置に着工指示 | − |

### 3.2 App 側の判定ロジック（R1, R3）

```
MES予約受信(equipment_id, card_no)
  │
  │ ── [判定1] ポート競合/ダミーロットチェック (R3) ──
  │
  ├─ 装置がポート競合待ち対象か？
  │   └─ YES → 現在処理中ポートを取得
  │       ├─ 処理中ポートなし → PASS
  │       ├─ 次回使用予定ポート（事前取得可能な場合）と同一 → PASS
  │       └─ 次回使用予定ポートと異なる → ダミーロット処理が必要
  │           ├─ ダミーロット自動投入が有効 → ダミーロット投入 → WAIT
  │           └─ 手動対応 → オペレータ通知 → WAIT
  │
  │ ── [判定2] 時間制約チェック (R1) ──
  │
  ├─ 次回レシピID を取得（MESから別途問い合わせ or App推定）
  │   └─ 取得不可 → 時間制約判定スキップ → PASS
  │
  ├─ recipe_id → recipe_group_id を引き当て
  │   └─ 対象外 → PASS
  │
  ├─ scope に応じた判定キーで last_complete_at を取得
  │   └─ 存在しない（初回） → ALLOW
  │
  ├─ elapsed_sec = now - last_complete_at
  │   ├─ elapsed_sec <= max_interval_sec → ALLOW
  │   └─ elapsed_sec >  max_interval_sec → REJECT
  │
  └─ ALLOW → 装置へ着工指示
     REJECT → オペレータ通知 + MES に REJECT 応答
     WAIT   → 条件成立まで保留
```

### 3.3 MES 側の参考チェック（R4）

```
予約登録(equipment_id, card_no)
  │
  ├─ App API を呼び出し、装置の前回完了時刻・対象レシピグループ・閾値を取得
  │   └─ 取得失敗 → 警告なしで予約続行
  │
  ├─ elapsed_sec = now - last_complete_at
  ├─ remaining_sec = max_interval_sec - elapsed_sec
  │
  ├─ remaining_sec <= 0 → 警告表示「既に時間超過しています」
  ├─ remaining_sec <= warning_threshold_sec（例: 600秒）
  │   → 警告表示「残り XX分XX秒です。至急処理してください」
  │
  └─ 予約登録は警告に関わらず実施
```

### 3.4 許可/拒否/待機ルール

| 条件 | 結果 | 理由コード | 対応 |
|------|------|-----------|------|
| 対象グループ外のレシピ | ALLOW | − | 着工続行 |
| 対象グループ初回着工（前回実績なし） | ALLOW | − | 着工続行 |
| ポート競合あり（ダミーロット必要） | **WAIT** | `PORT_CONFLICT_DUMMY_REQUIRED` | ダミーロット投入 |
| 経過時間 ≤ 閾値 | ALLOW | − | 着工続行 |
| 経過時間 > 閾値 | **REJECT** | `TIME_WINDOW_EXCEEDED` | オペレータ判断 |

### 3.5 介在レシピの扱い

- 対象グループ外のレシピはいつでも着工可能
- 介在中も対象グループのタイマーは経過し続ける（起点は前回完了時刻で固定）
- 介在レシピの完了は `last_complete_at` を更新しない

```
例: レシピグループ A の制約 = 3600秒以内

  t=0     グループA完了 → last_complete_at = 0
  t=300   グループB着工 →                         (ALLOW, タイマー無関係)
  t=900   グループB完了 →                         (タイマー更新なし)
  t=1000  グループA着工 → elapsed=1000 ≤ 3600     (ALLOW)
  t=1600  グループA完了 → last_complete_at = 1600
  t=5700  グループA着工 → elapsed=4100 > 3600     (REJECT: 時間超過)
```

### 3.6 ポート競合とダミーロット（R3）の詳細

```
例: 装置Xはポート競合時にダミーロット処理が必要

  現在: ポートA でロット処理中
  予約: 次回ロットがポートB を使用予定

  → ポートA ≠ ポートB → ダミーロット処理が必要
  → App が自動でダミーロットを投入（ポートB のコンディション調整用）
  → ダミーロット完了後、本来のロットを着工

  ※ 装置によってはダミーロット不要（設定で ON/OFF）
  ※ ダミーロットのレシピ・投入タイミングは装置ごとに異なる
```

---

## 4. データ設計

### 4.1 App 側マスタ（装置個別）

#### `recipe_time_window_rule` — 時間制約ルール定義

| カラム | 型 | 説明 |
|--------|-----|------|
| `rule_id` | PK | ルールID |
| `equipment_id` | FK | 対象装置 |
| `recipe_group_id` | VARCHAR | 対象レシピグループ識別子 |
| `scope` | ENUM | `EQUIPMENT` / `PORT` |
| `max_interval_sec` | INT | 許容間隔（秒）※前回完了からの経過 |
| `enabled` | BOOL | 有効/無効 |
| `updated_at` | TIMESTAMP | 更新日時 |

#### `recipe_group_mapping` — レシピ→グループ紐付け

| カラム | 型 | 説明 |
|--------|-----|------|
| `recipe_group_id` | FK | レシピグループ |
| `recipe_id` | VARCHAR | 個別レシピID |

#### `port_dummy_lot_rule` — ポートダミーロット処理ルール（R3用）

| カラム | 型 | 説明 |
|--------|-----|------|
| `equipment_id` | PK | 対象装置 |
| `dummy_lot_required` | BOOL | ダミーロット処理が必要か |
| `auto_insert` | BOOL | 自動投入するか（手動の場合 false） |
| `dummy_recipe_id` | VARCHAR / NULL | ダミーロット用レシピID |
| `enabled` | BOOL | 有効/無効 |
| `updated_at` | TIMESTAMP | 更新日時 |

### 4.2 App 側状態テーブル

#### `equipment_recipe_group_state` — 前回完了状態

| カラム | 型 | 説明 |
|--------|-----|------|
| `equipment_id` | FK | 装置 |
| `port_id` | VARCHAR / NULL | ポート（`scope=EQUIPMENT` の場合 NULL） |
| `recipe_group_id` | FK | レシピグループ |
| `last_recipe_id` | VARCHAR | 前回レシピID |
| `last_port_ids` | VARCHAR[] | 前回使用ポート一覧 |
| `last_complete_at` | TIMESTAMP | **前回完了時刻**（タイマー起点） |
| `last_card_no` | VARCHAR | 前回カードNo |
| `updated_at` | TIMESTAMP | 更新日時 |

#### `equipment_port_state` — 装置ポート処理状態（R3用）

| カラム | 型 | 説明 |
|--------|-----|------|
| `equipment_id` | FK | 装置 |
| `port_id` | VARCHAR | ポートID |
| `status` | ENUM | `IDLE` / `PROCESSING` / `DUMMY_PROCESSING` |
| `processing_card_no` | VARCHAR / NULL | 処理中カードNo |
| `processing_recipe_id` | VARCHAR / NULL | 処理中レシピID |
| `is_dummy` | BOOL | ダミーロット処理中か |
| `start_at` | TIMESTAMP / NULL | 処理開始時刻 |
| `updated_at` | TIMESTAMP | 更新日時 |

### 4.3 App 側ログテーブル

#### `start_judgement_log` — 判定履歴

| カラム | 型 | 説明 |
|--------|-----|------|
| `log_id` | PK | ログID |
| `equipment_id` | FK | 装置 |
| `port_id` | VARCHAR / NULL | 判定ポート |
| `card_no` | VARCHAR | カードNo |
| `recipe_id` | VARCHAR / NULL | 今回レシピ（取得不可の場合 NULL） |
| `recipe_group_id` | VARCHAR / NULL | 対象グループ（非対象なら NULL） |
| `prev_recipe_id` | VARCHAR / NULL | 前回レシピ |
| `prev_port_ids` | VARCHAR[] / NULL | 前回使用ポート |
| `judgement` | ENUM | `ALLOW` / `REJECT` / `WAIT` / `SKIP` |
| `elapsed_sec` | INT / NULL | 前回完了からの経過秒数 |
| `threshold_sec` | INT / NULL | 閾値 |
| `dummy_lot_inserted` | BOOL | ダミーロット投入したか |
| `reason_code` | VARCHAR / NULL | 理由コード |
| `created_at` | TIMESTAMP | 判定日時 |

### 4.4 MES 側（参考警告用 API）

MES は App に対して以下の API を呼び出し、参考情報を取得する：

**API**: `GET /api/equipment/{equipment_id}/time-window-status`

**レスポンス**:
```json
{
  "equipment_id": "EQ001",
  "recipe_groups": [
    {
      "recipe_group_id": "GROUP_A",
      "last_complete_at": "2026-02-16T10:30:00Z",
      "max_interval_sec": 3600,
      "elapsed_sec": 2400,
      "remaining_sec": 1200,
      "status": "WARNING"  // OK / WARNING / CRITICAL / EXCEEDED
    }
  ]
}
```

---

## 5. 処理フロー（v4）

### 5.1 予約フェーズ（MES）

```
1. オペレータが予約登録（装置 + カードNo）
2. [R4: 参考チェック] MES → App API 呼び出し
     GET /api/equipment/{equipment_id}/time-window-status
3. App が前回完了時刻・経過時間・残り時間を返却
4. MES が警告判定
     → 残り時間が少ない場合、画面に警告表示
     「警告: 装置 EQ001 のレシピグループ A は残り 20分です」
5. オペレータ確認後、予約登録
6. MES → App へ予約通知（装置 + カードNo）
```

### 5.2 着工判定フェーズ（App）

```
7. App が MES からの予約を受信
8. [R3: ポート競合チェック]
     → ダミーロット必要 → 自動投入 or 手動対応 → WAIT
9. [R1: 時間制約チェック]
     → 次回レシピID を取得（MESから問い合わせ or 推定）
     → 対象グループの場合、経過時間チェック
     → REJECT の場合、オペレータ通知 + MES に REJECT 応答
10. 全判定 ALLOW → App → 装置へ着工指示
```

### 5.3 完了フェーズ（App）

```
11. 装置から処理完了通知を受信
12. レシピ → グループを引き当て
13. 対象グループの場合:
      → last_complete_at = 完了時刻
      → last_recipe_id, last_port_ids を更新
14. equipment_port_state を IDLE に更新
15. WAIT キューに該装置の保留着工があれば再判定を実行
16. MES に完了通知（MES 側で完了時刻を記録）
```

---

## 6. 例外・運用考慮

| 項目 | 対応方針 |
|------|---------|
| **時刻同期** | App・MES 双方が完了時刻を保持。App 側の値を正とする（NTP 同期前提） |
| **API タイムアウト** | MES → App の参考チェック API がタイムアウトした場合、警告なしで予約続行 |
| **次回レシピID取得失敗** | App が次回レシピIDを取得できない場合、時間制約判定をスキップ（安全側で ALLOW） |
| **同時着工排他** | 状態テーブルの更新は装置単位で排他制御 |
| **App再起動** | 状態テーブルは永続化済み。WAIT キューはインメモリの場合、起動時に再構築 |
| **一時解除** | ルールの `enabled` を OFF にする運用スイッチ |
| **ダミーロット失敗** | ダミーロット処理が失敗した場合、本来のロットは REJECT |
| **異常完了** | 処理が異常終了した場合も完了時刻を記録するか、リセットするかは運用取り決め |

---

## 7. 仕様差分まとめ（v3→v4）

| 項目 | v3 | v4（今回） |
|------|-----|-----------|
| 着工指示の発行元 | MES | **App → 装置**（MES ではない） |
| レシピ想定処理時間 | App マスタに存在 | **どのシステムも保持していない** |
| 残時間 vs 処理時間チェック（旧R4） | 着工判定で実施 | **削除**（処理時間不明のため実現不可） |
| 新R4: MES予約時参考チェック | なし | **追加**（MES が App API で前回状態を取得し警告表示） |
| ダミーロット処理（R3拡張） | 単純な WAIT | **ダミーロット自動投入**を追加 |
| 判定の責任分界 | 不明確 | **MES（参考警告）/ App（最終判定）** を明確化 |
| MES IF 変更 | 不要 | **App API 追加**（参考チェック用、既存予約IFは変更なし） |
| データ突合 | 着工指示の前回情報と突合 | **不要**（着工指示は App 発行のため） |

---

## 8. 未確定事項（確認依頼）

1. **MES→App の次回レシピID取得方法**: 予約時点で MES から App にレシピIDを渡すか、別途問い合わせAPIを用意するか
2. **ダミーロットのタイミング**: ポート競合検知時に即座に投入するか、一定時間前に予測投入するか
3. **参考警告の閾値**: MES の警告表示は残り何秒から表示するか（例: 600秒）
4. **WAIT タイムアウト**: ダミーロット・ポート競合 WAIT が一定時間経過しても解消しない場合のタイムアウト時間
5. **異常完了時の扱い**: 完了時刻を記録するか、タイマーをリセットするか

上記が確定すれば、実装仕様（App コード設計・MES API 仕様・DB DDL・エラーコード一覧・シーケンス図）に進められます。
